<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AnimeChat Pro - ZAFAR Rooms</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:0;background:#000;color:#fff;width:100%;height:100vh;overflow:hidden}
    .anime-bg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;background:#000 url('background.png') center/cover;opacity:0.5;filter:brightness(0.8) contrast(1.3) saturate(1.5)}
    .red-light{position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 50%,rgba(255,45,45,0.4) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(255,20,20,0.3) 0%,transparent 50%);z-index:-1;mix-blend-mode:screen}
    .chat-header{position:fixed;top:0;width:100%;background:rgba(0,0,0,0.9);backdrop-filter:blur(15px);padding:12px 15px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,45,45,0.3);z-index:100;height:60px;box-sizing:border-box}
    .header-left{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:10px;overflow:hidden;border:2px solid #ff2d2d;background:linear-gradient(135deg,#ff2d2d,#b30000);display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 0 20px rgba(255,45,45,0.6)}
    .header-text h2{margin:0;font-size:18px;color:#ff2d2d;text-shadow:0 0 10px rgba(255,45,45,0.5)}
    .header-text small{font-size:12px;opacity:0.7}
    .chat-container{position:fixed;top:60px;bottom:110px;width:100%;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:10px;box-sizing:border-box}
    .messages{display:flex;flex-direction:column;gap:10px;min-height:100%}
    .message{max-width:80%;padding:12px 16px;border-radius:18px;position:relative;word-wrap:break-word;backdrop-filter:blur(5px);animation:fadeIn 0.3s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .sent{align-self:flex-end;background:linear-gradient(135deg,#0084ff,#0066cc);color:#fff;border-bottom-right-radius:5px;box-shadow:0 5px 20px rgba(0,132,255,0.4)}
    .received{align-self:flex-start;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);border-bottom-left-radius:5px}
    .sender-name{font-size:12px;font-weight:bold;margin-bottom:4px;opacity:0.9;display:flex;justify-content:space-between;align-items:center}
    .message-time{font-size:10px;opacity:0.6;margin-left:10px}
    .message-actions{display:none;gap:10px;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.1);justify-content:flex-end}
    .message-action-btn{background:none;border:none;color:rgba(255,255,255,0.5);font-size:14px;cursor:pointer;padding:4px 8px;border-radius:4px;transition:all 0.2s}
    .message-action-btn:hover{background:rgba(255,255,255,0.1);color:#fff}
    .input-area{position:fixed;bottom:50px;width:100%;padding:12px 15px;background:rgba(0,0,0,0.85);backdrop-filter:blur(15px);border-top:1px solid rgba(255,45,45,0.2);display:flex;gap:10px;z-index:100;box-sizing:border-box}
    #messageInput{flex:1;padding:12px 18px;border-radius:24px;border:none;background:rgba(255,255,255,0.1);color:#fff;font-size:14px;outline:none;border:1px solid rgba(255,45,45,0.3)}
    #messageInput::placeholder{color:rgba(255,255,255,0.5)}
    #sendButton{width:44px;height:44px;border-radius:50%;border:none;background:linear-gradient(135deg,#ff2d2d,#b30000);color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 5px 15px rgba(255,45,45,0.5)}
    .emoji-picker{position:fixed;bottom:110px;right:15px;background:rgba(0,0,0,0.95);border:1px solid rgba(255,45,45,0.3);border-radius:10px;padding:10px;display:none;grid-template-columns:repeat(6,1fr);gap:5px;max-width:200px;z-index:1000;box-shadow:0 5px 20px rgba(0,0,0,0.5)}
    .emoji-btn{background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:5px;border-radius:5px;transition:background 0.2s}
    .emoji-btn:hover{background:rgba(255,45,45,0.2)}
    .nav-bar{position:fixed;bottom:0;width:100%;background:rgba(0,0,0,0.95);backdrop-filter:blur(15px);display:flex;height:50px;border-top:1px solid rgba(255,45,45,0.2);z-index:100}
    .nav-item{flex:1;text-align:center;color:rgba(255,255,255,0.6);font-size:12px;cursor:pointer;display:flex;flex-direction:column;justify-content:center;align-items:center}
    .nav-item.active{color:#ff2d2d;text-shadow:0 0 10px rgba(255,45,45,0.5)}
    .nav-icon{font-size:20px;margin-bottom:2px}
    .sidebar,.online-sidebar{position:fixed;top:0;width:280px;height:100%;background:rgba(0,0,0,0.98);backdrop-filter:blur(25px);z-index:1000;transition:transform 0.3s ease;overflow-y:auto;padding:20px;box-sizing:border-box}
    .sidebar{left:0;transform:translateX(-100%);border-right:2px solid rgba(255,45,45,0.3)}
    .sidebar.show{transform:translateX(0)}
    .online-sidebar{right:0;transform:translateX(100%);border-left:2px solid rgba(0,132,255,0.3)}
    .online-sidebar.show{transform:translateX(0)}
    .chatroom{display:flex;align-items:center;gap:12px;padding:12px;margin-bottom:10px;background:rgba(255,255,255,0.05);border-radius:12px;cursor:pointer;transition:0.3s;border:1px solid transparent}
    .chatroom:hover{background:rgba(255,45,45,0.15);border-color:rgba(255,45,45,0.5)}
    .chatroom.active{background:rgba(255,45,45,0.2);border-color:rgba(255,45,45,0.7);box-shadow:0 5px 15px rgba(255,45,45,0.2)}
    .room-avatar{width:50px;height:50px;border-radius:10px;background:linear-gradient(135deg,#ff2d2d,#b30000);display:flex;align-items:center;justify-content:center;font-size:20px}
    .online-user{display:flex;align-items:center;gap:12px;padding:10px;margin-bottom:8px;background:rgba(255,255,255,0.05);border-radius:10px;border-left:3px solid #25d366}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#0084ff,#0066cc);display:flex;align-items:center;justify-content:center;font-weight:bold}
    .sticker-menu{position:fixed;bottom:110px;left:10px;right:10px;background:rgba(0,0,0,0.98);border:2px solid rgba(255,45,45,0.5);border-radius:15px;z-index:1000;display:none;flex-direction:column;max-height:350px;box-shadow:0 10px 30px rgba(255,45,45,0.4)}
    .sticker-header{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;border-bottom:1px solid rgba(255,45,45,0.3);background:rgba(255,45,45,0.15);border-radius:15px 15px 0 0}
    .sticker-header h3{margin:0;color:#ff2d2d;font-size:16px;text-shadow:0 0 10px rgba(255,45,45,0.5)}
    .close-sticker-menu{background:none;border:none;color:#ff2d2d;font-size:20px;cursor:pointer;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
    .close-sticker-menu:hover{background:rgba(255,45,45,0.3);transform:rotate(90deg)}
    .sticker-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;padding:15px;overflow-y:auto}
    .sticker-item{background:rgba(255,255,255,0.05);border-radius:12px;padding:10px;cursor:pointer;transition:all 0.3s;border:2px solid transparent;display:flex;align-items:center;justify-content:center}
    .sticker-item:hover{background:rgba(255,45,45,0.2);border-color:rgba(255,45,45,0.7);transform:scale(1.1);box-shadow:0 5px 15px rgba(255,45,45,0.3)}
    .sticker-item img{width:60px;height:60px;object-fit:contain;pointer-events:none}
    .sticker-btn{background:linear-gradient(135deg,#ff2d2d,#b30000);color:#fff;border:none;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 5px 15px rgba(255,45,45,0.5);transition:all 0.3s}
    .sticker-btn:hover{transform:scale(1.1);box-shadow:0 8px 20px rgba(255,45,45,0.7)}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:2000;align-items:center;justify-content:center;backdrop-filter:blur(10px)}
    .modal-content{background:rgba(20,8,12,0.98);padding:25px;border-radius:15px;width:90%;max-width:350px;border:2px solid rgba(255,45,45,0.5);box-shadow:0 0 40px rgba(255,45,45,0.3);text-align:center}
    .modal-content input{width:100%;padding:12px 15px;margin:15px 0;border-radius:10px;border:1px solid rgba(255,45,45,0.5);background:rgba(0,0,0,0.5);color:#fff;font-size:14px;box-sizing:border-box}
    .modal-content button{background:linear-gradient(135deg,#ff2d2d,#b30000);color:#fff;border:none;padding:12px 25px;border-radius:10px;font-size:14px;cursor:pointer;width:100%;margin-top:10px;box-shadow:0 5px 15px rgba(255,45,45,0.3)}
    .loading{text-align:center;padding:20px;color:rgba(255,255,255,0.6)}
    .secret-container{position:fixed;top:70px;right:10px;background:rgba(0,0,0,0.98);padding:15px;border-radius:10px;border:2px solid #ff2d2d;display:none;box-shadow:0 0 30px rgba(255,45,45,0.3);max-width:250px;z-index:1000}
    @media (max-width:768px){.sidebar,.online-sidebar{width:85%}.chat-container{padding:8px}.message{max-width:85%}.sticker-grid{grid-template-columns:repeat(4,1fr);gap:10px;padding:12px}.sticker-item img{width:50px;height:50px}}
    @media (max-width:480px){.sticker-grid{grid-template-columns:repeat(3,1fr)}}
  </style>
</head>
<body>
  <div class="anime-bg" id="animeBg"></div>
  <div class="red-light"></div>
  
  <div class="sticker-menu" id="stickerMenu">
    <div class="sticker-header">
      <h3>ğŸŒ Anime Stickers Pack</h3>
      <button class="close-sticker-menu" id="closeStickerMenu">âœ•</button>
    </div>
    <div class="sticker-grid" id="stickerGrid"></div>
  </div>
  
  <div class="secret-container" id="secretContainer">
    <h4 style="margin:0 0 10px;color:#ff2d2d;text-align:center">ğŸ”’ Secret Passwords</h4>
    <div style="font-size:12px;line-height:1.6">
      <div><strong>Room 1:</strong> <span id="secretPass1" style="color:#25d366">Loading...</span></div>
      <div><strong>Room 2:</strong> <span id="secretPass2" style="color:#25d366">Loading...</span></div>
      <div><strong>Room 3:</strong> <span id="secretPass3" style="color:#25d366">Loading...</span></div>
      <div><strong>Room 4:</strong> <span id="secretPass4" style="color:#25d366">Loading...</span></div>
      <div><strong>Room 5:</strong> <span id="secretPass5" style="color:#25d366">Loading...</span></div>
    </div>
    <button onclick="hideSecretPanel()" style="margin-top:10px;background:#ff2d2d;color:#fff;border:none;padding:5px 10px;border-radius:5px;font-size:10px;cursor:pointer;width:100%">Close</button>
  </div>
  
  <div class="chat-header">
    <div class="header-left">
      <button id="menuBtn" style="background:none;border:none;color:#ff2d2d;font-size:22px;cursor:pointer">â˜°</button>
      <div class="logo">ğŸŒ</div>
      <div class="header-text">
        <h2>AnimeChat Pro</h2>
        <small id="onlineCount">0 online</small>
      </div>
    </div>
    <div id="roomNameDisplay" style="color:#ff2d2d;font-weight:bold;font-size:14px;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">General Chat</div>
    <div style="display:flex;align-items:center;gap:10px">
      <button id="onlineBtn" style="background:none;border:none;color:#25d366;font-size:18px;cursor:pointer">ğŸ‘¥</button>
      <button id="secretBtn" style="background:none;border:none;color:#ff2d2d;font-size:18px;cursor:pointer">ğŸ‘ï¸</button>
    </div>
  </div>
  
  <div class="chat-container" id="chatContainer">
    <div class="messages" id="messages"><div class="loading" id="loading">Loading messages...</div></div>
  </div>
  
  <div class="input-area">
    <button class="sticker-btn" id="stickerBtn">ğŸŒ</button>
    <button id="emojiBtn" style="background:none;border:none;color:#ff2d2d;font-size:20px;cursor:pointer">ğŸ˜€</button>
    <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off">
    <button id="sendButton">â¤</button>
  </div>
  
  <div class="emoji-picker" id="emojiPicker">
    <button class="emoji-btn" data-emoji="ğŸ˜€">ğŸ˜€</button><button class="emoji-btn" data-emoji="ğŸ˜‚">ğŸ˜‚</button><button class="emoji-btn" data-emoji="ğŸ˜">ğŸ˜</button><button class="emoji-btn" data-emoji="ğŸ¥°">ğŸ¥°</button><button class="emoji-btn" data-emoji="ğŸ˜">ğŸ˜</button><button class="emoji-btn" data-emoji="ğŸ¤©">ğŸ¤©</button>
    <button class="emoji-btn" data-emoji="ğŸ˜Š">ğŸ˜Š</button><button class="emoji-btn" data-emoji="ğŸ™">ğŸ™</button><button class="emoji-btn" data-emoji="ğŸ‰">ğŸ‰</button><button class="emoji-btn" data-emoji="ğŸŒ">ğŸŒ</button><button class="emoji-btn" data-emoji="ğŸ”¥">ğŸ”¥</button><button class="emoji-btn" data-emoji="ğŸ’€">ğŸ’€</button>
  </div>
  
  <div class="nav-bar">
    <div class="nav-item active" data-tab="chat"><div class="nav-icon">ğŸ’¬</div><div>Chat</div></div>
    <div class="nav-item" data-tab="rooms"><div class="nav-icon">ğŸ”’</div><div>Rooms</div></div>
    <div class="nav-item" data-tab="theme"><div class="nav-icon">ğŸ¨</div><div>Theme</div></div>
    <div class="nav-item" data-tab="online"><div class="nav-icon">ğŸ‘¥</div><div><span id="onlineBadge">0</span> Online</div></div>
  </div>
  
  <div class="sidebar" id="sidebar">
    <h3 style="margin-top:0;color:#ff2d2d;text-align:center">ğŸ”’ Secret Rooms</h3>
    <div class="chatroom active" data-room="general" data-bg="background.png"><div class="room-avatar">#0</div><div class="room-info"><h4>General Chat <span style="color:#25d366">ğŸ”“</span></h4><small>Public â€¢ Everyone welcome</small></div></div>
    <div class="chatroom" data-room="Chatroom1" data-password="ZAFAR1" data-bg="bg1.png"><div class="room-avatar">#1</div><div class="room-info"><h4>Secret Room 1 <span style="color:#ff2d2d">ğŸ”’</span></h4><small style="color:#ff2d2d;background:rgba(255,45,45,0.1);padding:2px 8px;border-radius:10px;border:1px dashed rgba(255,45,45,0.3)">Password Protected</small></div></div>
    <div class="chatroom" data-room="Chatroom2" data-password="ZAFAR2" data-bg="bg2.png"><div class="room-avatar">#2</div><div class="room-info"><h4>Secret Room 2 <span style="color:#ff2d2d">ğŸ”’</span></h4><small style="color:#ff2d2d;background:rgba(255,45,45,0.1);padding:2px 8px;border-radius:10px;border:1px dashed rgba(255,45,45,0.3)">Password Protected</small></div></div>
    <div class="chatroom" data-room="Chatroom3" data-password="ZAFAR3" data-bg="bg3.png"><div class="room-avatar">#3</div><div class="room-info"><h4>Secret Room 3 <span style="color:#ff2d2d">ğŸ”’</span></h4><small style="color:#ff2d2d;background:rgba(255,45,45,0.1);padding:2px 8px;border-radius:10px;border:1px dashed rgba(255,45,45,0.3)">Password Protected</small></div></div>
    <div class="chatroom" data-room="Chatroom4" data-password="ZAFAR4" data-bg="bg4.png"><div class="room-avatar">#4</div><div class="room-info"><h4>Secret Room 4 <span style="color:#ff2d2d">ğŸ”’</span></h4><small style="color:#ff2d2d;background:rgba(255,45,45,0.1);padding:2px 8px;border-radius:10px;border:1px dashed rgba(255,45,45,0.3)">Password Protected</small></div></div>
    <div class="chatroom" data-room="Chatroom5" data-password="ZAFAR5" data-bg="bg5.png"><div class="room-avatar">#5</div><div class="room-info"><h4>Secret Room 5 <span style="color:#ff2d2d">ğŸ”’</span></h4><small style="color:#ff2d2d;background:rgba(255,45,45,0.1);padding:2px 8px;border-radius:10px;border:1px dashed rgba(255,45,45,0.3)">Password Protected</small></div></div>
  </div>
  
  <div class="online-sidebar" id="onlineSidebar">
    <h3 style="margin-top:0;color:#25d366;text-align:center">ğŸ‘¥ Online Users</h3>
    <div id="onlineUsersList"><div class="loading">Loading users...</div></div>
  </div>
  
  <div class="modal" id="nameModal">
    <div class="modal-content">
      <h2>ğŸŒ Welcome to AnimeChat</h2>
      <p>Enter your name to start chatting:</p>
      <input type="text" id="nameInput" placeholder="Enter your name..." autocomplete="off">
      <button id="submitName">Start Chatting</button>
      <p style="font-size:12px;margin-top:15px;opacity:0.7">ğŸ”¥ Real-time Chat<br>ğŸ”’ 5 password protected rooms<br>ğŸŒ 10 FREE Anime Stickers<br>ğŸ‘¥ Live Online Users</p>
    </div>
  </div>
  
  <div class="modal" id="passwordModal">
    <div class="modal-content">
      <h2>ğŸ”’ Password Required</h2>
      <p id="roomPrompt">Enter password for this room:</p>
      <input type="password" id="passwordInput" placeholder="Enter password..." autocomplete="off">
      <button id="submitPassword">Join Room</button>
      <button id="cancelPassword" style="background:rgba(255,255,255,0.1);margin-top:5px">Cancel</button>
    </div>
  </div>
</body>
</html>

<script>
// ========== FIXED CONFIG ==========
const CONFIG = {
  SECRET_PASSWORDS: {
    "Chatroom1": "ZAFAR1",
    "Chatroom2": "ZAFAR2", 
    "Chatroom3": "ZAFAR3",
    "Chatroom4": "ZAFAR4",
    "Chatroom5": "ZAFAR5"
  },
  
  STICKERS: [
    { id: 1, name: "Gojo Satoru", file: "sticker1.png" },
    { id: 2, name: "Nezuko Kamado", file: "sticker2.png" },
    { id: 3, name: "Luffy", file: "sticker3.png" },
    { id: 4, name: "Sailor Moon", file: "sticker4.png" },
    { id: 5, name: "Tanjiro", file: "sticker5.png" },
    { id: 6, name: "Pikachu", file: "sticker6.png" },
    { id: 7, name: "Kakashi", file: "sticker7.png" },
    { id: 8, name: "Mikasa", file: "sticker8.png" },
    { id: 9, name: "Totoro", file: "sticker9.png" },
    { id: 10, name: "Anya Forger", file: "sticker10.png" }
  ],
  
  FIREBASE_CONFIG: {
    apiKey: "AIzaSyB8zMhCjGxmHBpruABYA4pBj3jU0uMHCs0",
    authDomain: "zafi-chat-app.firebaseapp.com",
    projectId: "zafi-chat-app",
    storageBucket: "zafi-chat-app.firebasestorage.app",
    messagingSenderId: "989950346714",
    appId: "1:989950346714:web:7bad7f8fae2a72ce0bace3",
    measurementId: "G-XW5MS2D2K7",
    databaseURL: "https://zafi-chat-app-default-rtdb.asia-southeast1.firebasedatabase.app"
  }
};

// ========== FIXED STATE ==========
let currentUser = {
  name: '',
  id: '',
  room: 'general'
};

let app = {
  firebase: null,
  database: null,
  auth: null
};

// ========== FIXED ELEMENTS ==========
const elements = {
  chatContainer: document.getElementById('chatContainer'),
  messages: document.getElementById('messages'),
  messageInput: document.getElementById('messageInput'),
  sendButton: document.getElementById('sendButton'),
  stickerBtn: document.getElementById('stickerBtn'),
  stickerMenu: document.getElementById('stickerMenu'),
  closeStickerMenu: document.getElementById('closeStickerMenu'),
  stickerGrid: document.getElementById('stickerGrid'),
  nameModal: document.getElementById('nameModal'),
  passwordModal: document.getElementById('passwordModal'),
  nameInput: document.getElementById('nameInput'),
  passwordInput: document.getElementById('passwordInput'),
  roomPrompt: document.getElementById('roomPrompt'),
  sidebar: document.getElementById('sidebar'),
  onlineSidebar: document.getElementById('onlineSidebar'),
  menuBtn: document.getElementById('menuBtn'),
  onlineBtn: document.getElementById('onlineBtn'),
  secretBtn: document.getElementById('secretBtn'),
  emojiBtn: document.getElementById('emojiBtn'),
  emojiPicker: document.getElementById('emojiPicker'),
  roomNameDisplay: document.getElementById('roomNameDisplay'),
  onlineCount: document.getElementById('onlineCount'),
  onlineBadge: document.getElementById('onlineBadge'),
  onlineUsersList: document.getElementById('onlineUsersList'),
  secretContainer: document.getElementById('secretContainer'),
  chatrooms: document.querySelectorAll('.chatroom'),
  navItems: document.querySelectorAll('.nav-item'),
  loading: document.getElementById('loading')
};

// ========== FIXED FIREBASE ==========
function initializeFirebase() {
  return new Promise((resolve) => {
    if (typeof firebase === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js';
      script.onload = () => {
        const authScript = document.createElement('script');
        authScript.src = 'https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js';
        authScript.onload = () => {
          const dbScript = document.createElement('script');
          dbScript.src = 'https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js';
          dbScript.onload = () => {
            try {
              app.firebase = firebase.initializeApp(CONFIG.FIREBASE_CONFIG);
              app.database = firebase.database();
              app.auth = firebase.auth();
              console.log('âœ… Firebase loaded');
              resolve(true);
            } catch (e) {
              console.warn('Firebase error');
              resolve(false);
            }
          };
          dbScript.onerror = () => resolve(false);
          document.head.appendChild(dbScript);
        };
        authScript.onerror = () => resolve(false);
        document.head.appendChild(authScript);
      };
      script.onerror = () => resolve(false);
      document.head.appendChild(script);
    } else {
      try {
        app.firebase = firebase.initializeApp(CONFIG.FIREBASE_CONFIG);
        app.database = firebase.database();
        app.auth = firebase.auth();
        console.log('âœ… Firebase loaded');
        resolve(true);
      } catch (e) {
        resolve(false);
      }
    }
  });
}

// ========== FIXED STICKER SYSTEM ==========
function initStickerSystem() {
  elements.stickerBtn.addEventListener('click', () => {
    elements.stickerMenu.style.display = elements.stickerMenu.style.display === 'flex' ? 'none' : 'flex';
    elements.emojiPicker.style.display = 'none';
  });
  
  elements.closeStickerMenu.addEventListener('click', () => {
    elements.stickerMenu.style.display = 'none';
  });
  
  document.addEventListener('click', (e) => {
    if (!elements.stickerMenu.contains(e.target) && e.target !== elements.stickerBtn) {
      elements.stickerMenu.style.display = 'none';
    }
  });
  
  loadStickers();
}

function loadStickers() {
  elements.stickerGrid.innerHTML = '';
  
  CONFIG.STICKERS.forEach(sticker => {
    const stickerDiv = document.createElement('div');
    stickerDiv.className = 'sticker-item';
    stickerDiv.title = sticker.name;
    
    // ALAG ALAG STICKER KE LIYE EVENT LISTENER
    stickerDiv.innerHTML = `
      <img src="${sticker.file}" alt="${sticker.name}" 
           onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\"><rect width=\"100\" height=\"100\" fill=\"%23ff2d2d\"/><text x=\"50\" y=\"60\" font-size=\"40\" fill=\"white\" text-anchor=\"middle\">${sticker.id}</text></svg>'">
    `;
    
    // HAR STICKER KA ALAG EVENT LISTENER
    stickerDiv.addEventListener('click', () => {
      console.log(`ğŸŒ Selected sticker: ${sticker.name}`);
      sendSticker(sticker.file, sticker.name);
    });
    
    elements.stickerGrid.appendChild(stickerDiv);
  });
  
  console.log(`âœ… Loaded ${CONFIG.STICKERS.length} stickers`);
}

function sendSticker(stickerFile, stickerName) {
  if (!currentUser.name) {
    alert('Please enter your name first!');
    elements.nameModal.style.display = 'flex';
    return;
  }
  
  if (!currentUser.room) {
    alert('Please join a room first!');
    return;
  }
  
  console.log(`ğŸŒ Sending sticker: ${stickerName}`);
  
  const messageData = {
    type: 'sticker',
    stickerFile: stickerFile,
    stickerName: stickerName,
    senderId: currentUser.id,
    senderName: currentUser.name,
    timestamp: Date.now()
  };
  
  // REAL-TIME FIREBASE SEND
  if (app.database && app.database.ref) {
    app.database.ref('rooms/' + currentUser.room + '/messages').push(messageData)
      .then(() => {
        console.log('âœ… Sticker sent to Firebase');
        elements.stickerMenu.style.display = 'none';
      })
      .catch(error => {
        console.warn('Failed to send sticker:', error);
        // LOCAL FALLBACK
        addMessageToUI(messageData);
        elements.stickerMenu.style.display = 'none';
      });
  } else {
    // LOCAL FALLBACK
    addMessageToUI(messageData);
    elements.stickerMenu.style.display = 'none';
  }
}

// ========== FIXED MESSAGE SYSTEM ==========
function initMessageSystem() {
  elements.sendButton.addEventListener('click', sendMessage);
  
  elements.messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
}

function sendMessage() {
  const text = elements.messageInput.value.trim();
  if (!text) return;
  
  if (!currentUser.name) {
    alert('Please enter your name first!');
    elements.nameModal.style.display = 'flex';
    return;
  }
  
  console.log(`ğŸ’¬ Sending: ${text}`);
  
  const messageData = {
    text: text,
    senderId: currentUser.id,
    senderName: currentUser.name,
    timestamp: Date.now(),
    type: 'text'
  };
  
  // REAL-TIME FIREBASE SEND
  if (app.database && app.database.ref) {
    app.database.ref('rooms/' + currentUser.room + '/messages').push(messageData)
      .then(() => {
        elements.messageInput.value = '';
        elements.messageInput.focus();
      })
      .catch(error => {
        console.warn('Failed to send:', error);
        // LOCAL FALLBACK
        addMessageToUI(messageData);
        elements.messageInput.value = '';
        elements.messageInput.focus();
      });
  } else {
    // LOCAL FALLBACK
    addMessageToUI(messageData);
    elements.messageInput.value = '';
    elements.messageInput.focus();
  }
}

// ========== FIXED ROOM SYSTEM ==========
let messageListener = null;

function loadMessages() {
  elements.loading.style.display = 'block';
  elements.messages.innerHTML = '';
  
  // PEHLE WALA LISTENER HATAO
  if (messageListener && app.database) {
    app.database.ref('rooms/' + currentUser.room + '/messages').off('value', messageListener);
  }
  
  if (app.database && app.database.ref) {
    const messagesRef = app.database.ref('rooms/' + currentUser.room + '/messages');
    
    // REAL-TIME LISTENER (DONO USERS KO SAME MESSAGE DIKHEGA)
    messageListener = messagesRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
      elements.loading.style.display = 'none';
      elements.messages.innerHTML = '';
      
      if (snapshot.exists()) {
        const messages = [];
        snapshot.forEach(child => {
          messages.push({
            id: child.key,
            ...child.val()
          });
        });
        
        messages.sort((a, b) => a.timestamp - b.timestamp);
        messages.forEach(msg => addMessageToUI(msg));
        
        setTimeout(() => {
          elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
        }, 100);
      } else {
        showSystemMessage(`Welcome to ${currentUser.room}! Be the first to send a message.`);
      }
    }, (error) => {
      console.warn('Load error:', error);
      showDemoMessages();
    });
  } else {
    showDemoMessages();
  }
}

function showDemoMessages() {
  elements.loading.style.display = 'none';
  elements.messages.innerHTML = '';
  
  const demoMessages = [
    { senderName: "System", text: "Welcome to AnimeChat Pro!", timestamp: Date.now() - 60000 },
    { senderName: "Bot", text: "Connect to internet for real-time chat with other users!", timestamp: Date.now() - 30000 },
    { senderName: "Admin", text: "Send messages, stickers & enjoy!", timestamp: Date.now() }
  ];
  
  demoMessages.forEach(msg => {
    addMessageToUI(msg);
  });
}

function addMessageToUI(message) {
  const isSentByMe = message.senderId === currentUser.id;
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isSentByMe ? 'sent' : 'received'}`;
  
  const time = new Date(message.timestamp).toLocaleTimeString([], { 
    hour: '2-digit', minute: '2-digit' 
  });
  
  let content = '';
  if (message.type === 'sticker') {
    content = `
      <div style="text-align:center;padding:5px;">
        <img src="${message.stickerFile}" alt="${message.stickerName}" 
             style="max-width:120px;max-height:120px;border-radius:10px;border:2px solid rgba(255,255,255,0.1);"
             onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\"color:#ff2d2d;padding:10px;\">ğŸŒ ${message.stickerName}</div>';">
        <div style="font-size:11px;opacity:0.7;margin-top:5px;background:rgba(255,255,255,0.05);padding:3px 8px;border-radius:10px;">${message.stickerName}</div>
      </div>
    `;
  } else {
    content = message.text || '';
  }
  
  messageDiv.innerHTML = `
    <div class="sender-name">
      <span>${message.senderName || 'Unknown'} ${isSentByMe ? '(You)' : ''}</span>
      <span class="message-time">${time}</span>
    </div>
    ${content}
  `;
  
  elements.messages.appendChild(messageDiv);
}

function showSystemMessage(text) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message received';
  messageDiv.style.background = 'rgba(255, 45, 45, 0.1)';
  messageDiv.style.border = '1px dashed rgba(255, 45, 45, 0.3)';
  messageDiv.innerHTML = `
    <div class="sender-name">
      <span style="color:#ff2d2d;">âš™ï¸ System</span>
      <span class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
    </div>
    ${text}
  `;
  elements.messages.appendChild(messageDiv);
}

// ========== FIXED ROOM MANAGEMENT ==========
function initRoomSystem() {
  elements.chatrooms.forEach(room => {
    room.addEventListener('click', () => {
      const roomName = room.getAttribute('data-room');
      const password = room.getAttribute('data-password');
      const bgFile = room.getAttribute('data-bg');
      
      if (roomName === currentUser.room) {
        elements.sidebar.classList.remove('show');
        return;
      }
      
      if (password) {
        showPasswordModal(roomName, password, bgFile);
      } else {
        switchRoom(roomName, bgFile);
      }
    });
  });
}

function showPasswordModal(roomName, requiredPassword, bgFile) {
  elements.roomPrompt.textContent = `Enter password for "${roomName}":`;
  elements.passwordModal.style.display = 'flex';
  elements.passwordInput.focus();
  elements.passwordInput.value = '';
  
  elements.passwordModal.dataset.room = roomName;
  elements.passwordModal.dataset.password = requiredPassword;
  elements.passwordModal.dataset.bg = bgFile;
}

function switchRoom(roomName, bgFile) {
  console.log(`ğŸšª Switching to room: ${roomName}`);
  
  // CLEAR MESSAGES
  elements.messages.innerHTML = '<div class="loading">Loading messages...</div>';
  
  // UPDATE USER STATE
  currentUser.room = roomName;
  elements.roomNameDisplay.textContent = roomName;
  
  // UPDATE ACTIVE ROOM UI
  elements.chatrooms.forEach(room => {
    room.classList.remove('active');
    if (room.getAttribute('data-room') === roomName) {
      room.classList.add('active');
    }
  });
  
  // CHANGE BACKGROUND
  if (bgFile) {
    document.getElementById('animeBg').style.backgroundImage = `url('${bgFile}')`;
  }
  
  // LOAD MESSAGES FOR NEW ROOM
  loadMessages();
  
  // CLOSE SIDEBAR
  elements.sidebar.classList.remove('show');
  
  // SHOW WELCOME MESSAGE
  setTimeout(() => {
    showSystemMessage(`Welcome to ${roomName}! Start chatting now.`);
  }, 500);
}

// ========== FIXED USER SYSTEM ==========
function initializeUser() {
  // HAR USER KA UNIQUE ID BANAO
  currentUser.id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  
  console.log('âœ… User registered:', currentUser.name, 'ID:', currentUser.id);
  
  // UPDATE ONLINE STATUS
  updateOnlineStatus();
  
  // LOAD MESSAGES
  loadMessages();
  
  // FOCUS INPUT
  setTimeout(() => {
    elements.messageInput.focus();
    showSystemMessage(`Welcome ${currentUser.name}! You joined ${currentUser.room}.`);
  }, 500);
}

function updateOnlineStatus() {
  if (!currentUser.id || !currentUser.name || !app.database) return;
  
  const userStatusRef = app.database.ref('status/' + currentUser.id);
  
  userStatusRef.set({
    name: currentUser.name,
    online: true,
    lastSeen: Date.now(),
    room: currentUser.room,
    userId: currentUser.id
  });
  
  userStatusRef.onDisconnect().update({
    online: false,
    lastSeen: Date.now()
  });
  
  // LISTEN FOR OTHER USERS
  app.database.ref('status').on('value', (snapshot) => {
    const users = [];
    let onlineCount = 0;
    
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const user = child.val();
        if (user.online && user.userId !== currentUser.id) {
          users.push(user);
          onlineCount++;
        }
      });
    }
    
    elements.onlineBadge.textContent = onlineCount;
    elements.onlineCount.textContent = onlineCount + ' online';
    
    if (users.length === 0) {
      elements.onlineUsersList.innerHTML = '<div class="loading">No other users online</div>';
    } else {
      let html = '';
      users.forEach(user => {
        html += `
          <div class="online-user">
            <div class="user-avatar">${user.name.charAt(0).toUpperCase()}</div>
            <div>
              <strong>${user.name}</strong><br>
              <small>In: ${user.room || 'general'}</small>
            </div>
          </div>
        `;
      });
      elements.onlineUsersList.innerHTML = html;
    }
  });
}

// ========== FIXED UI SYSTEMS ==========
function initEmojiSystem() {
  elements.emojiBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    elements.emojiPicker.style.display = elements.emojiPicker.style.display === 'grid' ? 'none' : 'grid';
    elements.stickerMenu.style.display = 'none';
  });
  
  elements.emojiPicker.querySelectorAll('.emoji-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      elements.messageInput.value += btn.getAttribute('data-emoji');
      elements.messageInput.focus();
      elements.emojiPicker.style.display = 'none';
    });
  });
  
  document.addEventListener('click', (e) => {
    if (!elements.emojiPicker.contains(e.target) && e.target !== elements.emojiBtn) {
      elements.emojiPicker.style.display = 'none';
    }
  });
}

function initSidebarSystem() {
  let activeSidebar = null;
  
  function toggleSidebar(sidebar) {
    if (activeSidebar === sidebar) {
      sidebar.classList.remove('show');
      activeSidebar = null;
    } else {
      if (activeSidebar) activeSidebar.classList.remove('show');
      sidebar.classList.add('show');
      activeSidebar = sidebar;
    }
    
    elements.stickerMenu.style.display = 'none';
    elements.emojiPicker.style.display = 'none';
  }
  
  elements.menuBtn.addEventListener('click', () => toggleSidebar(elements.sidebar));
  elements.onlineBtn.addEventListener('click', () => toggleSidebar(elements.onlineSidebar));
  
  document.addEventListener('click', (e) => {
    if (activeSidebar && 
        !activeSidebar.contains(e.target) && 
        e.target !== elements.menuBtn && 
        e.target !== elements.onlineBtn) {
      activeSidebar.classList.remove('show');
      activeSidebar = null;
    }
  });
}

function initSecretPanel() {
  elements.secretBtn.addEventListener('click', () => {
    const isVisible = elements.secretContainer.style.display === 'block';
    elements.secretContainer.style.display = isVisible ? 'none' : 'block';
    
    if (!isVisible) {
      document.getElementById('secretPass1').textContent = CONFIG.SECRET_PASSWORDS.Chatroom1;
      document.getElementById('secretPass2').textContent = CONFIG.SECRET_PASSWORDS.Chatroom2;
      document.getElementById('secretPass3').textContent = CONFIG.SECRET_PASSWORDS.Chatroom3;
      document.getElementById('secretPass4').textContent = CONFIG.SECRET_PASSWORDS.Chatroom4;
      document.getElementById('secretPass5').textContent = CONFIG.SECRET_PASSWORDS.Chatroom5;
    }
  });
  
  document.addEventListener('click', (e) => {
    if (!elements.secretContainer.contains(e.target) && e.target !== elements.secretBtn) {
      elements.secretContainer.style.display = 'none';
    }
  });
}

// ========== FIXED EVENT LISTENERS ==========
function initEventListeners() {
  // NAME SUBMISSION - HAR BAAR NAME POOCHEGA
  document.getElementById('submitName').addEventListener('click', () => {
    currentUser.name = elements.nameInput.value.trim();
    if (!currentUser.name) {
      currentUser.name = 'AnimeFan' + Math.floor(Math.random() * 1000);
    }
    
    if (currentUser.name) {
      localStorage.setItem('animechat_username', currentUser.name);
      elements.nameModal.style.display = 'none';
      document.title = currentUser.name + ' - AnimeChat Pro';
      
      // FIREBASE INITIALIZE KARO PHIR USER
      initializeFirebase().then(firebaseLoaded => {
        if (firebaseLoaded) {
          initializeUser();
        } else {
          // OFFLINE MODE
          currentUser.id = 'offline_' + Date.now();
          showSystemMessage(`Welcome ${currentUser.name}! (Offline Mode)`);
          loadMessages();
        }
      });
    }
  });
  
  elements.nameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('submitName').click();
    }
  });
  
  // PASSWORD SUBMISSION
  document.getElementById('submitPassword').addEventListener('click', () => {
    const roomName = elements.passwordModal.dataset.room;
    const requiredPassword = elements.passwordModal.dataset.password;
    const bgFile = elements.passwordModal.dataset.bg;
    const enteredPassword = elements.passwordInput.value.trim().toUpperCase();
    
    if (enteredPassword === requiredPassword) {
      switchRoom(roomName, bgFile);
      elements.passwordModal.style.display = 'none';
      elements.passwordInput.value = '';
    } else {
      alert('âŒ Wrong password! Try again.');
      elements.passwordInput.focus();
    }
  });
  
  document.getElementById('cancelPassword').addEventListener('click', () => {
    elements.passwordModal.style.display = 'none';
    elements.passwordInput.value = '';
  });
  
  elements.passwordInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('submitPassword').click();
    }
  });
  
  // NAVIGATION
  elements.navItems.forEach(item => {
    item.addEventListener('click', () => {
      elements.navItems.forEach(nav => nav.classList.remove('active'));
      item.classList.add('active');
      
      const tab = item.getAttribute('data-tab');
      if (tab === 'rooms') {
        elements.sidebar.classList.add('show');
      } else if (tab === 'online') {
        elements.onlineSidebar.classList.add('show');
      } else if (tab === 'theme') {
        const bgFiles = ['background.png', 'bg1.png', 'bg2.png', 'bg3.png', 'bg4.png', 'bg5.png'];
        const currentBg = document.getElementById('animeBg').style.backgroundImage;
        let currentIndex = 0;
        
        for (let i = 0; i < bgFiles.length; i++) {
          if (currentBg.includes(bgFiles[i])) {
            currentIndex = i;
            break;
          }
        }
        
        const nextIndex = (currentIndex + 1) % bgFiles.length;
        document.getElementById('animeBg').style.backgroundImage = `url('${bgFiles[nextIndex]}')`;
        showSystemMessage(`Theme changed to Background ${nextIndex + 1}`);
      }
    });
  });
  
  // CHAT CONTAINER HEIGHT
  function adjustChatHeight() {
    const headerHeight = document.querySelector('.chat-header').offsetHeight;
    const inputHeight = document.querySelector('.input-area').offsetHeight;
    const navHeight = document.querySelector('.nav-bar').offsetHeight;
    
    elements.chatContainer.style.height = `calc(100vh - ${headerHeight + inputHeight + navHeight}px)`;
  }
  
  adjustChatHeight();
  window.addEventListener('resize', adjustChatHeight);
}

// ========== FIXED APP INITIALIZATION ==========
async function initializeApp() {
  console.log('ğŸš€ AnimeChat Pro LOADED');
  
  // INITIALIZE UI SYSTEMS
  initStickerSystem();
  initEmojiSystem();
  initSidebarSystem();
  initSecretPanel();
  initRoomSystem();
  initMessageSystem();
  initEventListeners();
  
  // HAR BAAR NAME MODAL SHOW KARO (SAVED USER BHI)
  elements.nameModal.style.display = 'flex';
  elements.nameInput.focus();
  
  // RANDOM DEFAULT NAME
  elements.nameInput.value = 'AnimeFan' + Math.floor(Math.random() * 1000);
  
  console.log('ğŸ†• Please enter your name to start chatting');
}

// ========== START APP ==========
document.addEventListener('DOMContentLoaded', initializeApp);

window.hideSecretPanel = () => {
  elements.secretContainer.style.display = 'none';
};
</script>